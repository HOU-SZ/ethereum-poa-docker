import json
import codecs
from Crypto.Hash import keccak
import sys
import os
import ecdsa

nodes_path = sys.argv[1]
number_node = sys.argv[2]
chain_id = int(sys.argv[3])


def exportGenesis(consortium, chainId):
    pubKeyList = readPubKeys()
    addressList = getAdresses(pubKeyList)
    res = {}
    if consortium == "poa":
        res = cliqueGenesis(addressList, chainId)
    with open(nodes_path+"/genesis.json", "w") as outfile:
        json.dump(res, outfile)
    outfile.close()
    return


def cliqueGenesis(addresses, chainId):
    res = baseGenesis()
    res["alloc"] = {
        addresses[0][2:]: {
            "balance": "0x2000000000000000000000000000000000000000000000"
        },
        # addresses[1][2:]: {
        #     "balance": "0x2000000000000000000000000000000000000000000000"
        # },
        # addresses[2][2:]: {
        #     "balance": "0x2000000000000000000000000000000000000000000000"
        # },
        # addresses[3][2:]: {
        #     "balance": "0x2000000000000000000000000000000000000000000000"
        # },
        "726cd31966308E4b5af0f479f3d00586Db997328": {
            "balance": "0x2000000000000000000000000000000000000000000000"
        },
        "3b8aedfc21731a008ddfe93682f1d0fe0d6134cc": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"8b2ef1f473173e97acfeb8dfd82cfece9662949c": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"67b42fd2c83d35dc5b424598d61bce363b395338": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"6fe0009551f4838e31d67bea9ed3fbf75ac19755": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"007602d24be945091481e7c052374c78d0fb589c": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"6f7f76f227bde0e1fac2fb37ed070cb5c54d867b": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"6fb7245a3328fc6b6b42aa76dc2c3d267419934a": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"3aa85e9df503ba05a808f4412a4e6b1130f85ddf": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"ea6a3083f9ce58e9e199cf04615c4036ffbd8c43": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"e3472a0dd95fafff3d233a1ec4d47a593d0fa1f1": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"cb35cfeab1ce5658612988adb67e309547c97f7e": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"1e0c379802c92df326e0f7555714ec1d6a06e4e6": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"6bb66b7d7277a87596af1c915a2b4f26f742eead": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"ca5afb24de68c811cd288342a3e07cd6a2197180": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"35a5da576f0e8487f6924a5ea1ea47e009fc90e4": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"ce92d852d4b5ebb18d05f3e63df578135d24e34e": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"2c0c756cb8bd538b9e7882f47dd691627042cb68": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"e1dc5954d235c2d9a2a7a73206f999dc013c3782": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"c4c9f5a1205c1f397faac665588f4e0ef61ee4cd": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"b3d0ea7a28fc6223ddf6bb36140b21317462ec9b": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"b9b1a15cfb45fb9d7a7905f6c019509ae0a8d4c8": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"84497bae70c3bd7b6b77a7a16c68a913254af603": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"436f95c56b049e33ebd7bca247209452545ebcf7": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"bbdfb17103f1d299edba26d148d79ccb6691205d": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"e0fcf4c00618d630bcdcf844a0a515dc0b464a7b": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"2ed36c746dabc4b7407ef32bc833276cabd58bbf": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"c1916e5c193201e7010b9c3fe72aa7e7668ad877": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"5b7d209fb0baebc1ca1e605eaa0aa6cb4901a79d": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"5cb140941df4a95c5480658c0c338bc80398b1ea": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"1b7f0a7e7765f7c30bac725de43f9b7f108a5e44": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"39d669ebec958c7003ce1f5c37103cc160e17252": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"dcc20b23ad2d6069c9bb49993458fb18441a1c43": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"dbebeee631694feca3b319a4e0f78c958772b5ec": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"19c7c2f8eedc6e064b6363d3e3aa57a8455caff2": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"c3cafbf78afc690bb29865c2121af86e251e8df7": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"394cadd834cd6a542cf4d7b555463eb019a9cee6": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"664acf0982b1ef553b5e2c1f98b3f77bfd8f1f3a": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"1c38b5beca42ee0e21b62c30ef3ecc4b47988881": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"574747d274a9b2feeb9d9f1d7a45162e4b533cd6": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"4d48db04ab9620c6bc63eb01c41e29d5d26c5cbb": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"c71b6d197f90369f5c30ebfd23f7080f51b7d1ef": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"81111be4a355c34e66fe92a25cb295c97dbd21cb": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"3ce60f4b9e138a4e70b9ae5d2f69819fd9c990af": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"2fc9be57db232f1db054e283128c00440ea679ba": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"53c39b37f41d35d98407d53e7926679fed6da615": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"cf7cba2963c4c7089e96237b1fd1454be72dc0c2": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"6bbddd44b531a217ba084c722b277f56d1bbb26c": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"22939259a1c8d83eeb02786aadd717cbbb39298a": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"4b77f851ee9bcd8df16af320a5b256ad6e066836": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"fae43915a9c9252ca8fd3d3ae8f4332ae833b391": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"891f326a358b8a78af43f3f2b28e7a2571d20fca": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"7b67646043e81ecee0a62f2f476fe3c5b8fa67d6": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"2c8cedf2d883cdc4f7b54f80f9a2e7360ccdf3d6": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"40f907d26dc98923d4050eef75c93250679aa676": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"33d47430c6d66d06b0f7bc57f6cebb2e8ca0e329": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"886324bf4410f6d2b2fca0f862824a845268e325": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"2b914724f0a69d3804347fa7862ed33a4ad38ddf": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"43a5260f074a96a32da149225651f3b6e01c40d8": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"6313af3da8fbd7eaa771697537a04e1febb62496": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"b7f003ff6078dd1f5cfabdbf27f222d91e859009": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"6401ae59ffae2d489dae3d89b15833d14fdb3429": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"7f32f78b8cbdde256928bcd23013394c900b3d2c": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"c5dcc7786a8c3c8a09c495a227b0f3c999c52593": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"71e2d6e87d69b0a509e2b610ce2528d7a1476c47": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"bb1dc4126f05256e0738be9dbf57a359141790ed": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"3e9667f157dba539e6de60f8a48f6ff95b105505": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"79713ff9e01fd538bcbb98eb45240d3d04e58377": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"ef70514188f4c1f1243eac3b3f5bdef047008170": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"406e18091270ba9bdbb368d1162036d4c06df6e2": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"3a3739dc2da8e8c2c84c63e4c6f4e8cd9cc09eac": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"8c8e0178a082c8a03e6795f2942eade650ff2834": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"04e970d4f8994fdef00f35ec0e586d669c2bdf15": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"840ed03ed876edd29feb6102155c54fa4169a167": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"cdfc0deae602446b936ce2d0e9ab84169e04bb93": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"9317375954c3ea300b7bcba4be50f3df65fb6712": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"25975c8b3dac3552e03c66733042235a75619dfe": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"85b4f181f5819e7a36967a65d5efd1f9079a3736": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"211d214b58a28c444bde57fad5e4e7c23179d8ac": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"aaace505b699d2adb17dd95596dfa278dfedb368": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"cee113f20dcb5adc600aeb7dd4e8504eef9c60a0": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"036f621b79edd26d42b897916522801b85d87b5c": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"9e24833ffcca3d826782f83fe9a837a1d3cfb57f": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"962df29b2b4afada0355104bdc10b7a76277562b": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"f355b016127f13e8fff3f825116482ea75f45cc5": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"5bd0538f1808e95e8b59c246016227e439e721ff": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"81b4fdb48a2766651632bc9b12b9f1ab7c222e66": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"8bb239b8b23829b1d706c23a150505b03ab18a7b": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"21c4093925a8885d11a9b095bbfd0e5dcc19909d": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"01ec080165c58732db1b6cb0b928ba918b14d1e2": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"bf1d4608b15aa536ffcebe5ca5b27a9375fbde7e": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"e48ff95ad40319b3cea6f2d1c4c45f37d7942dd2": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"9ba6966496eb4ca0cf7654bb43d0ab9ab54d129a": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"71b6106fc22831a295a14af434a1f57ae86ea71c": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"7d8a41e37dedc8d5bd553095fc0fdc12951f5bdf": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"ea1a4e9fdc665dde7465db95059208acc65d77f2": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"dcfd0ad6f41689a09e1da06c6b7b2484e9b4554d": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"6084e9b30956c4cd83f8a8d5d72dffe413d93750": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"7dc8e46a022da0ce37cbc205884eb6a40c4f555a": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"86302e04c4d4502561bfd7edaeae470990589524": {"balance": "0x2000000000000000000000000000000000000000000000"},
		"994c226e6fc08acbe97093a020e037cde7442d49": {"balance": "0x2000000000000000000000000000000000000000000000"}
    }
    concataddress = "0x0000000000000000000000000000000000000000000000000000000000000000"
    for address in addresses:
        concataddress += address[2:]
    concataddress += "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    res["extraData"] = concataddress
    res["config"] = {
        "chainId": chainId,
        "homesteadBlock": 0,
        "eip150Block": 0,
        "eip150Hash": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "eip155Block": 0,
        "eip158Block": 0,
        "byzantiumBlock": 0,
        "constantinopleBlock": 0,
        "petersburgBlock": 0,
        "istanbulBlock": 0,
        "clique": {
            "period": 4,
            "epoch": 30000
        }
    }
    res["nonce"] = "0x0"
    res["difficulty"] = "0x1"
    res["timestamp"] = "0x5f5e100"
    return res


def baseGenesis():
    return {
        "mixhash": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "coinbase": "0x0000000000000000000000000000000000000000",
        "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "gasLimit": "0x2625a00"
    }


def getAdresses(pubKeyList):
    res = []
    for pubKey in pubKeyList:
        res.append(public_to_address(pubKey.strip()))
    return res


def readPubKeys():
    res = []
    for i in range(1, int(number_node)+1):
        filename = nodes_path+"/node_"+str(i)+"/keys/pub.key"
        fileReader = open(filename, "r")
        currentLine = fileReader.readline()
        while currentLine != "":
            res.append(currentLine.strip())
            currentLine = fileReader.readline()
        fileReader.close()
    return res


def public_to_address(public_key):
    public_key_bytes = codecs.decode(public_key, "hex")
    keccak_hash = keccak.new(digest_bits=256)
    keccak_hash.update(public_key_bytes)
    keccak_digest = keccak_hash.hexdigest()
    # Take last 20 bytes
    wallet_len = 40
    wallet = "0x" + keccak_digest[-wallet_len:]
    return wallet


if __name__ == "__main__":
    exportGenesis("poa", chain_id)
